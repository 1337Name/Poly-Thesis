# Polyglot file project
This project is coded only in python. It includes six different generation techniques for Polyglot files. These include BMP, JPEG, PNG and PDF based polyglot generators. It is possible to generate a Corpus of file for testing. This includes a json with details for each generated file. The project further includes a framework for detecting using four different detection programs, outputting the results in a json file. It further contains some pyhton scripts for evaluation of the results. 

## How to use
First one needs to gather all the dependencies from requirements.txt file. Note that polydet does not have a pip package. It can be found at https://github.com/Polydet/polydet. Further, the Mitra tool is needed to get a baseline comparison with known techniques. It can be found at https://github.com/corkami/mitra (default path: `~/tools/mitra/mitra.py`, configure via `--mitra-path` parameter on run_generation). ImageMagick is required for JPEGPixelGenerator, for this the `convert` command must be in PATH. In order to do the automated generation sample files are needed. The directory structure should look as follows samples/fileformat for each fileformat in lower case, e.g. samples/bmp, samples/jpeg, samples/js etc. containing the sample files for that file type. Then generation can be started using `python3 -m generation.run_generation`. A limit for how many samples to take for each file format can be specified using the `--limit` flag. When finished it should have created polyglot files and a run.json in the generated/ directory. Now one can run the detection using `python3 -m detection.run_detection` which reads the generated/run.json file, processes all files and should generate a detection_results.json file. It is important to note that the detection loop can only be run on unix based systems as it uses signals to detect the timeout of a tool. The results in detection_results.json can now be analyzed. Interactive Plotly graphs can be generated on a html page using evaluation/generate_graphs.py. More thesis friendly (i.e. readable) graphs can be generated using evalutation/generate_graphs_latex.py

It is also possible to run each generator as a standalone script: `python3 -m generation.BMPPixelGenerator host.bmp payload.js output.bmp`



## How to extend
### Extending generation
To add a new generator one needs to implement the interface defined by the baseGenerator abstract class. That is, most importantly, there needs to be a generate method taking host and payload as raw bytes and returning the polyglot as raw bytes. It is important to raise any errors that can occur during generation so only valid polyglots are used for detection. Then it can be added to ALL_GENERATORS in the generation/run_generation.py file. 

To add new covert file types one just needs to add the appropriate samples to the appropriate samples subdirectory. Then add the the format to the COVERT_ALLOWED array in the generation/run_generation.py file. Further the appropriate types to normalize from and to should be added to detection/types.py if a full evluation run is needed. 

### Extending detection
To extend detection all that is needed is to create a new subclass for BaseDetector. This mainly  implementing the detect method. This requires taking a file path as argument, running some detection logic and then returning a DetectionResult type object with the appropriate data.  

### Extending evaluation
To make a new evaluation program one just has to parse the JSON file detection_results.json generated by the detection framework. This is aided by the make_result and make_error methods of the superclass. The results need to contain the normalized file types, for this the _normalize method of the superclass should be used. 